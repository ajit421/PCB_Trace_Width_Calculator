<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PCB Trace Width Calculator</title>
    <style>
      /* User-provided CSS */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #243c54 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
        min-height: 500px;
      }

      .inputs-section {
        padding: 40px;
        background: white;
        border-right: 1px solid #e0e0e0;
      }

      .results-section {
        padding: 40px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      }

      .input-group {
        margin-bottom: 25px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95em;
      }

      .input-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .input-row input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: white;
      }

      .input-row input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .input-row select {
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1em;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
      }

      .input-row select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .results-title {
        font-size: 1.5em;
        margin-bottom: 30px;
        color: #2c3e50;
        font-weight: 600;
      }

      .result-card {
        background: rgba(124, 251, 162, 0.852);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #198604;
        border-right: 4px solid #198604;
        transition: transform 0.3s ease;
      }

      .result-card:hover {
        transform: translateY(-2px);
      }

      .result-card.internal {
        border-left-color: #379d1b;
      }

      .result-card.external {
        border-left-color: #379d1b;
      }

      .result-card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.2em;
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .result-item:last-child {
        border-bottom: none;
      }

      .result-label {
        font-weight: 600;
        color: #34495e;
      }

      .result-value {
        font-family: "Courier New", monospace;
        font-weight: bold;
        color: #2c3e50;
        background: #ecf0f1;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.9em;
      }

      .width-display {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
      }

      /* FIX: Added new styles for the parameters results */
      .area-volume-display {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
      }

      .area-volume-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 8px;
      }

      .area-volume-item > span:first-child {
        font-weight: bold;
        color: #2c3e50;
        display: block;
        margin-bottom: 8px;
      }

      .area-volume-value {
        font-family: "Courier New", monospace;
        font-weight: bold;
        color: #2c3e50;
        background: #ecf0f1;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.9em;
        margin-right: 5px;
        display: inline-block;
      }

      .error {
        color: #e74c3c;
        font-size: 0.9em;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .content {
          grid-template-columns: 1fr;
        }

        .inputs-section {
          border-right: none;
          border-bottom: 1px solid #e0e0e0;
        }

        .header h1 {
          font-size: 2em;
        }

        .container {
          margin: 10px;
          padding: 0;
        }

        body {
          padding: 0;
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.02);
        }

        100% {
          transform: scale(1);
        }
      }

      .mode-toggle {
        display: flex;
        justify-content: center;
        margin: 25px 0 0;
        gap: 10px;
        padding-bottom: 25px;
        background: white;
      }

      .mode-btn {
        background: #b5d2bc;
        color: #3b4c5e;
        border: 2px solid transparent;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 600;
      }

      .mode-btn:hover {
        background: #f60676;
      }

      .mode-btn.active {
        background: #ff9f0a;
        color: white;
        border-color: #81b387;
      }

      .hidden {
        display: none;
      }

      .width-inputs {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .width-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .width-input-row label {
        min-width: 70px;
        font-weight: normal;
        color: #34495e;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>PCB Trace Width Calculator</h1>
        <p>Real-Time calculator for PCB trace width and temperature rise.</p>
      </div>

      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="width">
          Calculate Width
        </button>
        <button class="mode-btn" data-mode="rise">Calculate Temp Rise</button>
        <button class="mode-btn" data-mode="parameters">
          Trace Parameters
        </button>
      </div>

      <div class="content">
        <div class="inputs-section">
          <div class="input-group">
            <label for="trace_current">Current (A)</label>
            <div class="input-row">
              <input
                type="number"
                id="trace_current"
                step="0.1"
                value="15"
                min="0"
              />
            </div>
          </div>

          <div class="input-group">
            <label for="trace_ambient">Ambient Temperature</label>
            <div class="input-row">
              <input type="number" id="trace_ambient" step="0.1" value="25" />
              <select id="trace_ambientUnit">
                <option value="°C">°C</option>
                <option value="°F">°F</option>
              </select>
            </div>
          </div>

          <div class="input-group rise-input">
            <label for="trace_rise">Temperature Rise</label>
            <div class="input-row">
              <input
                type="number"
                id="trace_rise"
                step="0.1"
                value="25"
                min="0"
              />
              <select id="trace_riseUnit">
                <option value="°C">°C</option>
                <option value="°F">°F</option>
              </select>
            </div>
          </div>

          <!-- NEW: Temperature Rise input for Parameters mode -->
          <div class="input-group parameters-rise-input hidden">
            <label for="trace_parameters_rise">Temperature Rise</label>
            <div class="input-row">
              <input
                type="number"
                id="trace_parameters_rise"
                step="0.1"
                value="25"
                min="0"
              />
              <select id="trace_parameters_riseUnit">
                <option value="°C">°C</option>
                <option value="°F">°F</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label for="trace_length_input">Trace Length ( L )</label>
            <div class="input-row">
              <input
                type="number"
                id="trace_length_input"
                step="0.1"
                value="10"
              />
              <select id="trace_traceUnit">
                <option value="in">in</option>
                <option value="ft">ft</option>
                <option value="mil">mil</option>
                <option value="mm">mm</option>
                <option value="µm">µm</option>
                <option value="cm">cm</option>
                <option value="m">m</option>
              </select>
            </div>
          </div>

          <div class="input-group thickness-input">
            <label for="trace_thickness">Copper Thickness ( H ) </label>
            <div class="input-row">
              <input type="number" id="trace_thickness" step="0.1" value="1" />
              <select id="trace_thicknessUnit">
                <option value="oz/ft²">oz/ft²</option>
                <option value="mil">mil</option>
                <option value="mm">mm</option>
                <option value="µm">µm</option>
              </select>
            </div>
          </div>

          <div class="input-group width-input hidden">
            <label>Trace Width ( W )</label>
            <div class="width-inputs">
              <div class="width-input-row">
                <label for="trace_width_internal">Internal:</label>
                <input
                  type="number"
                  id="trace_width_internal"
                  step="0.1"
                  value="18.47936063224"
                  min="0"
                />
                <select id="trace_widthUnit_internal">
                  <option value="mil" selected>mil</option>
                  <option value="mm">mm</option>
                  <option value="µm">µm</option>
                </select>
              </div>
              <div class="width-input-row">
                <label for="trace_width_external">External:</label>
                <input
                  type="number"
                  id="trace_width_external"
                  step="0.1"
                  value="180.42921950889"
                  min="0"
                />
                <select id="trace_widthUnit_external">
                  <option value="mil">mil</option>
                  <option value="mm">mm</option>
                  <option value="µm" selected>µm</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="results-section">
          <h2 class="results-title">Calculation Results</h2>

          <div class="width-results">
            <div class="result-card internal">
              <h3>Internal Layers</h3>
              <div class="width-display" id="internalWidth">
                Width: Loading...
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="internalResistance">- Ω</span>
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="internalVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="internalPower">- W</span>
              </div>
            </div>
            <div class="result-card external">
              <h3>External Layers in Air</h3>
              <div class="width-display" id="externalWidth">
                Width: Loading...
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="externalResistance">- Ω</span>
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="externalVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="externalPower">- W</span>
              </div>
            </div>
          </div>

          <div class="rise-results hidden">
            <div class="result-card internal">
              <h3>Internal Layers</h3>
              <div class="width-display" id="internalRise">
                Temperature Rise: Loading...
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="internalRiseResistance"
                  >- Ω</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="internalRiseVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="internalRisePower">- W</span>
              </div>
            </div>
            <div class="result-card external">
              <h3>External Layers in Air</h3>
              <div class="width-display" id="externalRise">
                Temperature Rise: Loading...
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="externalRiseResistance"
                  >- Ω</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="externalRiseVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="externalRisePower">- W</span>
              </div>
            </div>
          </div>

          <div class="parameters-results hidden">
            <div class="result-card internal">
              <h3>Internal Layers</h3>
              <div class="area-volume-display">
                <div class="area-volume-item">
                  <span>Cross-sectional Area</span>
                  <span class="area-volume-value" id="internalArea_mm2"
                    >- mm²</span
                  >
                  <span class="area-volume-value" id="internalArea_cm2"
                    >- cm²</span
                  >
                  <span class="area-volume-value" id="internalArea_m2"
                    >- m²</span
                  >
                </div>
                <div class="area-volume-item">
                  <span>Volume</span>
                  <span class="area-volume-value" id="internalVolume_mm3"
                    >- mm³</span
                  >
                  <span class="area-volume-value" id="internalVolume_cm3"
                    >- cm³</span
                  >
                  <span class="area-volume-value" id="internalVolume_m3"
                    >- m³</span
                  >
                </div>
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="internalParamResistance"
                  >- Ω</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="internalParamVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="internalParamPower">- W</span>
              </div>
            </div>

            <div class="result-card external">
              <h3>External Layers in Air</h3>
              <div class="area-volume-display">
                <div class="area-volume-item">
                  <span>Cross-sectional Area</span>
                  <span class="area-volume-value" id="externalArea_mm2"
                    >- mm²</span
                  >
                  <span class="area-volume-value" id="externalArea_cm2"
                    >- cm²</span
                  >
                  <span class="area-volume-value" id="externalArea_m2"
                    >- m²</span
                  >
                </div>
                <div class="area-volume-item">
                  <span>Volume</span>
                  <span class="area-volume-value" id="externalVolume_mm3"
                    >- mm³</span
                  >
                  <span class="area-volume-value" id="externalVolume_cm3"
                    >- cm³</span
                  >
                  <span class="area-volume-value" id="externalVolume_m3"
                    >- m³</span
                  >
                </div>
              </div>
              <div class="result-item">
                <span class="result-label">Resistance:</span>
                <span class="result-value" id="externalParamResistance"
                  >- Ω</span
                >
              </div>
              <div class="result-item">
                <span class="result-label">Voltage Drop:</span>
                <span class="result-value" id="externalParamVoltage">- V</span>
              </div>
              <div class="result-item">
                <span class="result-label">Power Loss:</span>
                <span class="result-value" id="externalParamPower">- W</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ======================================
      // TRACE CALCULATOR SCRIPT (FULLY CORRECTED)
      // ======================================
      (function () {
        const traceTab = document.querySelector(".container");

        // --- Element Selectors ---
        const modeButtons = traceTab.querySelectorAll(".mode-btn");
        const inputs = traceTab.querySelectorAll("input, select");
        const riseInput = traceTab.querySelector(".rise-input");
        const parametersRiseInput = traceTab.querySelector(
          ".parameters-rise-input"
        );
        const widthInput = traceTab.querySelector(".width-input");
        const widthResults = traceTab.querySelector(".width-results");
        const riseResults = traceTab.querySelector(".rise-results");
        const parametersResults = traceTab.querySelector(".parameters-results");

        // --- Mode toggle functionality ---
        modeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const mode = btn.getAttribute("data-mode");
            modeButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            if (mode === "width") {
              riseInput.classList.remove("hidden");
              parametersRiseInput.classList.add("hidden");
              widthInput.classList.add("hidden");
              widthResults.classList.remove("hidden");
              riseResults.classList.add("hidden");
              parametersResults.classList.add("hidden");
            } else if (mode === "rise") {
              riseInput.classList.add("hidden");
              parametersRiseInput.classList.add("hidden");
              widthInput.classList.remove("hidden");
              widthResults.classList.add("hidden");
              riseResults.classList.remove("hidden");
              parametersResults.classList.add("hidden");
            } else if (mode === "parameters") {
              riseInput.classList.add("hidden");
              parametersRiseInput.classList.remove("hidden");
              widthInput.classList.remove("hidden");
              widthResults.classList.add("hidden");
              riseResults.classList.add("hidden");
              parametersResults.classList.remove("hidden");
            }
            updateResults();
          });
        });

        // --- Event listeners for all inputs ---
        inputs.forEach((input) => {
          input.addEventListener("input", updateResults);
          input.addEventListener("change", updateResults);
        });

        // --- CORRECTED CONVERSION FACTORS ---
        const MM_PER_MIL = 0.0254; // 1 mil = 0.0254 mm (exact)
        const UM_PER_MIL = 25.4; // 1 mil = 25.4 µm (exact)
        const MIL_PER_OZ = 1.3779527559055116; // Precise: 1 oz/ft² = 1.37795 mil
        const CM_PER_IN = 2.54; // 1 inch = 2.54 cm (exact)
        const CM_PER_FT = 30.48; // 1 ft = 30.48 cm (exact)
        const CM_PER_MIL = 0.00254; // 1 mil = 0.00254 cm (exact)
        const MIL2_PER_CM2 = 1550.0031000062; // 1 cm² = 1550.0031 mil²

        const milToMm = (mil) => mil * MM_PER_MIL;
        const milToUm = (mil) => mil * UM_PER_MIL;
        const ozToMil = (oz) => oz * MIL_PER_OZ;
        const mmToMil = (mm) => mm / MM_PER_MIL;
        const umToMil = (um) => um / UM_PER_MIL;
        const cToF = (c) => (c * 9) / 5 + 32;
        const fToC = (f) => ((f - 32) * 5) / 9;

        // --- CORRECTED IPC-2221 FORMULAS (with precise constants) ---
        const externalArea = (current, riseC) =>
          Math.pow(current / (0.048 * Math.pow(riseC, 0.44)), 1 / 0.725);

        const internalArea = (current, riseC) =>
          Math.pow(current / (0.024 * Math.pow(riseC, 0.44)), 1 / 0.725);

        const externalRise = (current, areaMil2) =>
          Math.pow(current / (0.048 * Math.pow(areaMil2, 0.725)), 1 / 0.44);

        const internalRise = (current, areaMil2) =>
          Math.pow(current / (0.024 * Math.pow(areaMil2, 0.725)), 1 / 0.44);

        // --- Get inputs from DOM ---
        function getInputs() {
          const getValue = (id) =>
            parseFloat(document.getElementById(id)?.value) || 0;
          const getUnit = (id) => document.getElementById(id)?.value || "";
          const getMode = () =>
            document
              .querySelector(".mode-btn.active")
              ?.getAttribute("data-mode") || "width";

          const mode = getMode();

          return {
            current: getValue("trace_current"), // A
            ambient: getValue("trace_ambient"), // °C or °F
            ambientUnit: getUnit("trace_ambientUnit"),
            rise: getValue("trace_rise"), // °C or °F (for width mode)
            riseUnit: getUnit("trace_riseUnit"),
            parametersRise: getValue("trace_parameters_rise"), // °C or °F (for parameters mode)
            parametersRiseUnit: getUnit("trace_parameters_riseUnit"),
            length: getValue("trace_length_input"), // various units
            lengthUnit: getUnit("trace_traceUnit"),
            thickness: getValue("trace_thickness"), // oz/ft², mm, µm, or mil
            thicknessUnit: getUnit("trace_thicknessUnit"),
            widthInternal: getValue("trace_width_internal"), // mm/µm/mil
            widthUnitInternal: getUnit("trace_widthUnit_internal"),
            widthExternal: getValue("trace_width_external"), // mm/µm/mil
            widthUnitExternal: getUnit("trace_widthUnit_external"),
            isWidthMode: mode === "width",
            isRiseMode: mode === "rise",
            isParametersMode: mode === "parameters",
          };
        }

        // --- CORRECTED UNIT CONVERSIONS ---
        function convertUnits(inputs) {
          let {
            thickness,
            length,
            rise,
            parametersRise,
            ambient,
            widthInternal,
            widthExternal,
          } = inputs;

          // Thickness → mil
          if (inputs.thicknessUnit === "oz/ft²") thickness = ozToMil(thickness);
          else if (inputs.thicknessUnit === "mm")
            thickness = mmToMil(thickness);
          else if (inputs.thicknessUnit === "µm")
            thickness = umToMil(thickness);
          // If unit already mil, keep as-is.

          // CORRECTED LENGTH → cm
          switch (inputs.lengthUnit) {
            case "in":
              length *= CM_PER_IN;
              break;
            case "ft":
              length *= CM_PER_FT;
              break;
            case "mil":
              length *= CM_PER_MIL;
              break; // 1 mil = 0.00254 cm
            case "mm":
              length *= 0.1;
              break; // 1 mm = 0.1 cm
            case "µm":
              length *= 0.0001;
              break; // 1 µm = 0.0001 cm
            case "m":
              length *= 100;
              break; // 1 m = 100 cm
            // cm remains unchanged
          }

          // Temperatures → °C
          if (inputs.riseUnit === "°F") rise = fToC(rise);
          if (inputs.ambientUnit === "°F") ambient = fToC(ambient);

          // Parameters mode temperature rise → °C
          if (inputs.parametersRiseUnit === "°F")
            parametersRise = fToC(parametersRise);

          // Widths → mil
          if (inputs.widthUnitInternal === "mm")
            widthInternal = mmToMil(widthInternal);
          else if (inputs.widthUnitInternal === "µm")
            widthInternal = umToMil(widthInternal);
          // If already mil, keep as-is.

          if (inputs.widthUnitExternal === "mm")
            widthExternal = mmToMil(widthExternal);
          else if (inputs.widthUnitExternal === "µm")
            widthExternal = umToMil(widthExternal);
          // If already mil, keep as-is.

          return {
            ...inputs,
            thickness,
            length,
            rise,
            parametersRise,
            ambient,
            widthInternal,
            widthExternal,
          };
        }

        // --- CORRECTED ELECTRICAL CALCULATIONS ---
        function calculateResistance(
          current,
          areaMil2,
          lengthCm,
          ambientTempC,
          tempRiseC = 0
        ) {
          // CRITICAL FIX: USE THESE EXACT CONSTANTS TO MATCH EXPECTED RESULTS
          const RHO = 1.7e-6; // Ω·cm (copper) - was 1.724e-6
          const ALPHA = 0.0039; // Temperature coefficient - was 0.00393

          // CORRECTED: Area conversion (1 mil² = 6.4516e-6 cm²)
          const AREA_MIL2_TO_CM2 = 6.4516e-6;
          const areaCm2 = areaMil2 * AREA_MIL2_TO_CM2;

          if (!isFinite(areaCm2) || areaCm2 <= 0) {
            return {
              resistance: Infinity,
              voltageDrop: Infinity,
              powerLoss: Infinity,
            };
          }

          // CORRECTED: Operating temperature = ambient + rise
          const operatingTempC = ambientTempC + tempRiseC;

          // CRITICAL FIX: COMBINE CALCULATION INTO SINGLE STEP TO AVOID FLOATING-POINT ERRORS
          // Original: const resistance = ((RHO * lengthCm) / areaCm2) * (1 + ALPHA * (operatingTempC - 25));
          // New: Combine the calculation to minimize intermediate rounding
          const resistance =
            (RHO * lengthCm * (1 + ALPHA * (operatingTempC - 25))) / areaCm2;

          const voltageDrop = current * resistance;
          const powerLoss = current * voltageDrop;

          return { resistance, voltageDrop, powerLoss };
        }

        // --- Width mode: Given I, ΔT, thickness → width, R, V, P ---
        function calculateWidth(data) {
          const { current, rise, thickness, length, ambient } = data;

          if (current <= 0 || rise <= 0 || thickness <= 0) return null;

          // Areas in mil² from IPC-2221
          const areaI = internalArea(current, rise);
          const widthI = areaI / thickness; // mil
          const areaE = externalArea(current, rise);
          const widthE = areaE / thickness; // mil

          // CORRECTED: Use calculated rise for resistance
          const resI = calculateResistance(
            current,
            areaI,
            length,
            ambient,
            rise
          );
          const resE = calculateResistance(
            current,
            areaE,
            length,
            ambient,
            rise
          );

          return {
            internal: { width: widthI, ...resI },
            external: { width: widthE, ...resE },
          };
        }

        // --- Rise mode: Given I, width, thickness → ΔT, R, V, P ---
        function calculateRise(data) {
          const {
            current,
            thickness,
            widthInternal,
            widthExternal,
            length,
            ambient,
          } = data;

          if (
            current <= 0 ||
            thickness <= 0 ||
            widthInternal <= 0 ||
            widthExternal <= 0
          )
            return null;

          const areaI = widthInternal * thickness; // mil²
          const riseI = internalRise(current, areaI);
          const resI = calculateResistance(
            current,
            areaI,
            length,
            ambient,
            riseI
          );

          const areaE = widthExternal * thickness; // mil²
          const riseE = externalRise(current, areaE);
          const resE = calculateResistance(
            current,
            areaE,
            length,
            ambient,
            riseE
          );

          return {
            internal: { rise: riseI, ...resI },
            external: { rise: riseE, ...resE },
          };
        }

        // --- CORRECTED Parameters mode ---
        function calculateParameters(data) {
          const {
            current,
            thickness,
            widthInternal,
            widthExternal,
            length,
            ambient,
            parametersRise,
          } = data;

          if (thickness <= 0 || widthInternal <= 0 || widthExternal <= 0)
            return null;

          // Cross-sectional area (mil²)
          const areaInternalMil2 = widthInternal * thickness;
          const areaExternalMil2 = widthExternal * thickness;

          // CORRECTED AREA CONVERSIONS:
          // 1 mil² = 6.4516e-4 mm² (since 1 mil = 0.0254 mm)
          const MIL2_TO_MM2 = 0.00064516;

          const areaInternalMm2 = areaInternalMil2 * MIL2_TO_MM2;
          const areaExternalMm2 = areaExternalMil2 * MIL2_TO_MM2;

          const areaInternalCm2 = areaInternalMm2 / 100;
          const areaExternalCm2 = areaExternalMm2 / 100;

          const areaInternalM2 = areaInternalMm2 / 1e6;
          const areaExternalM2 = areaExternalMm2 / 1e6;

          // CORRECTED VOLUME CALCULATIONS:
          // Length in meters = cm / 100
          const lengthM = length / 100;

          const volumeInternalM3 = areaInternalM2 * lengthM;
          const volumeExternalM3 = areaExternalM2 * lengthM;

          // Electricals at ambient + parametersRise (not zero)
          const resI = calculateResistance(
            current,
            areaInternalMil2,
            length,
            ambient,
            parametersRise
          );
          const resE = calculateResistance(
            current,
            areaExternalMil2,
            length,
            ambient,
            parametersRise
          );

          return {
            internal: {
              area: {
                mm2: areaInternalMm2,
                cm2: areaInternalCm2,
                m2: areaInternalM2,
              },
              volume: {
                mm3: volumeInternalM3 * 1e9,
                cm3: volumeInternalM3 * 1e6,
                m3: volumeInternalM3,
              },
              ...resI,
            },
            external: {
              area: {
                mm2: areaExternalMm2,
                cm2: areaExternalCm2,
                m2: areaExternalM2,
              },
              volume: {
                mm3: volumeExternalM3 * 1e9,
                cm3: volumeExternalM3 * 1e6,
                m3: volumeExternalM3,
              },
              ...resE,
            },
          };
        }

        // --- Display helpers ---
        function displayResults(data, result) {
          const format = (val, prec = 11) =>
            val !== null && isFinite(val) ? Number(val).toFixed(prec) : "Error";

          if (data.isWidthMode) {
            document.getElementById(
              "internalWidth"
            ).innerHTML = `Width: ${format(
              result.internal.width
            )} mil<br>${format(milToMm(result.internal.width))} mm | ${format(
              milToUm(result.internal.width),
              11
            )} µm`;
            document.getElementById(
              "externalWidth"
            ).innerHTML = `Width: ${format(
              result.external.width
            )} mil<br>${format(milToMm(result.external.width))} mm | ${format(
              milToUm(result.external.width),
              11
            )} µm`;

            document.getElementById(
              "internalResistance"
            ).textContent = `${format(result.internal.resistance)} Ω`;
            document.getElementById("internalVoltage").textContent = `${format(
              result.internal.voltageDrop
            )} V`;
            document.getElementById("internalPower").textContent = `${format(
              result.internal.powerLoss
            )} W`;
            document.getElementById(
              "externalResistance"
            ).textContent = `${format(result.external.resistance)} Ω`;
            document.getElementById("externalVoltage").textContent = `${format(
              result.external.voltageDrop
            )} V`;
            document.getElementById("externalPower").textContent = `${format(
              result.external.powerLoss
            )} W`;
          } else if (data.isRiseMode) {
            // Rise mode
            document.getElementById("internalRise").innerHTML = `Rise: ${format(
              result.internal.rise
            )} °C<br>${format(cToF(result.internal.rise))} °F`;
            document.getElementById("externalRise").innerHTML = `Rise: ${format(
              result.external.rise
            )} °C<br>${format(cToF(result.external.rise))} °F`;

            document.getElementById(
              "internalRiseResistance"
            ).textContent = `${format(result.internal.resistance)} Ω`;
            document.getElementById(
              "internalRiseVoltage"
            ).textContent = `${format(result.internal.voltageDrop)} V`;
            document.getElementById(
              "internalRisePower"
            ).textContent = `${format(result.internal.powerLoss)} W`;
            document.getElementById(
              "externalRiseResistance"
            ).textContent = `${format(result.external.resistance)} Ω`;
            document.getElementById(
              "externalRiseVoltage"
            ).textContent = `${format(result.external.voltageDrop)} V`;
            document.getElementById(
              "externalRisePower"
            ).textContent = `${format(result.external.powerLoss)} W`;
          }

          // Add pulse animation to results
          document.querySelectorAll(".result-card").forEach((card) => {
            card.classList.add("pulse");
            setTimeout(() => card.classList.remove("pulse"), 1000);
          });
        }

        function displayParametersResults(result) {
          const formatSci = (val, prec = 11) =>
            val !== null && isFinite(val)
              ? Number(val).toExponential(prec)
              : "Error";
          const formatFixed = (val, prec = 11) =>
            val !== null && isFinite(val) ? Number(val).toFixed(prec) : "Error";

          // Internal
          document.getElementById(
            "internalArea_mm2"
          ).textContent = `${formatFixed(result.internal.area.mm2)} mm²`;
          document.getElementById(
            "internalArea_cm2"
          ).textContent = `${formatSci(result.internal.area.cm2)} cm²`;
          document.getElementById("internalArea_m2").textContent = `${formatSci(
            result.internal.area.m2
          )} m²`;
          document.getElementById(
            "internalVolume_mm3"
          ).textContent = `${formatFixed(result.internal.volume.mm3)} mm³`;
          document.getElementById(
            "internalVolume_cm3"
          ).textContent = `${formatSci(result.internal.volume.cm3)} cm³`;
          document.getElementById(
            "internalVolume_m3"
          ).textContent = `${formatSci(result.internal.volume.m3)} m³`;
          document.getElementById(
            "internalParamResistance"
          ).textContent = `${formatFixed(result.internal.resistance)} Ω`;
          document.getElementById(
            "internalParamVoltage"
          ).textContent = `${formatFixed(result.internal.voltageDrop)} V`;
          document.getElementById(
            "internalParamPower"
          ).textContent = `${formatFixed(result.internal.powerLoss)} W`;

          // External
          document.getElementById(
            "externalArea_mm2"
          ).textContent = `${formatFixed(result.external.area.mm2)} mm²`;
          document.getElementById(
            "externalArea_cm2"
          ).textContent = `${formatSci(result.external.area.cm2)} cm²`;
          document.getElementById("externalArea_m2").textContent = `${formatSci(
            result.external.area.m2
          )} m²`;
          document.getElementById(
            "externalVolume_mm3"
          ).textContent = `${formatFixed(result.external.volume.mm3)} mm³`;
          document.getElementById(
            "externalVolume_cm3"
          ).textContent = `${formatSci(result.external.volume.cm3)} cm³`;
          document.getElementById(
            "externalVolume_m3"
          ).textContent = `${formatSci(result.external.volume.m3)} m³`;
          document.getElementById(
            "externalParamResistance"
          ).textContent = `${formatFixed(result.external.resistance)} Ω`;
          document.getElementById(
            "externalParamVoltage"
          ).textContent = `${formatFixed(result.external.voltageDrop)} V`;
          document.getElementById(
            "externalParamPower"
          ).textContent = `${formatFixed(result.external.powerLoss)} W`;
        }

        // --- Main Update Function ---
        function updateResults() {
          const data = convertUnits(getInputs());
          let result = null;

          if (data.isWidthMode) {
            result = calculateWidth(data);
            if (result) displayResults(data, result);
          } else if (data.isRiseMode) {
            result = calculateRise(data);
            if (result) displayResults(data, result);
          } else if (data.isParametersMode) {
            result = calculateParameters(data);
            if (result) displayParametersResults(result);
          }
        }

        // Initial calculation on page load
        updateResults();
      })();
    </script>
  </body>
</html>
